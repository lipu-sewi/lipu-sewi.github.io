<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lipu sewi - Toki Pona Bible</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <style>
        /* === load nasin-nanpa === */
        @font-face {
            font-family: "NasinNanpa";
            src: url("font/nasin-nanpa-4.0.2.woff2") format("woff2");
            font-display: swap;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: system-ui, Segoe UI, Roboto, sans-serif;
            line-height: 1.6; color: #333; background-color: #f5f5f5;
            padding: 20px; max-width: 1200px; margin: 0 auto;
        }
        
        header, .controls, .chapter-container, .missing-verses, .debug-info {
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            background-color: white; padding: 20px; margin-bottom: 20px;
        }

        header { text-align: center; }
        .embed .full-view { display: none; }
        
        .controls { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        
        select, button {
            padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 16px; background-color: white; cursor: pointer;
        }
        
        button { background-color: #3498db; color: white; border: none; transition: 0.3s; }
        button:hover { background-color: #2980b9; }
        
        .display-options { display: flex; align-items: center; gap: 10px; }
        
        .chapter-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;
        }
        
        .chapter-title { font-size: 24px; color: #2c3e50; }

        /* Modes */
        .sitelen-pona-mode .st-problem { color: red; font-size: 14px; font-family: monospace; }
        .latina-pona-mode .st-problem { display: none; }
        
        .verse { border-radius: 4px; transition: 0.2s; padding: 10px; }
        .sitelen-pona-mode .verse { padding: 0; margin-bottom: 0; }
        .verse:hover { background-color: #f9f9f9; }
        .verse.highlighted { background-color: #fff8e1; border: 2px solid #ffd54f; }
        
        .verse-number-lt, .verse-number-st {
            font-weight: bold; color: #7f8c8d; vertical-align: top;
            width: 20px; display: inline-block; cursor: pointer;
        }

        .sitelen-pona-mode .verse-number-lt, .latina-pona-mode .verse-number-st { display: none; }
        .sitelen-pona-mode .verse-number-st { width: 75px; display: inline-block; margin-top: 5px; }

        .sitelen-pona-mode .verse-number-st .sitelen, .sitelen-pona-mode .verse-content {
            font-family: "NasinNanpa", serif; font-size: 24px; line-height: 0.5;
            white-space: pre-wrap; font-variant-ligatures: common-ligatures contextual;
        }

        .sitelen-pona-mode .verse-content { display: inline-block; margin-top: 10px; width: 384px; }
        
        .unsolidified { opacity: 0.7; border-left: 3px solid #e74c3c; }
        .solidified { border-left: 3px solid #2ecc71; }
        
        .space, .newline, .newline2 { display: none; }
        .sitelen-pona-mode .space { display: inline; opacity: 0; }
        .sitelen-pona-mode .newline, .sitelen-pona-mode .newline2 { display: block; height: 22px; opacity: 0; }
        .sitelen-pona-mode .punct { display: none; }

        .name-rect { display: inline-block; border: 2px solid #333; border-radius: 6px; padding: 4px 6px; margin: 0 4px; }
        .latina-pona-mode .name-rect, .sitelen-pona-mode .name-tp { display: none; }

        .nav-controls { display: flex; gap: 10px; justify-content: center; margin-top: 10px; width: 100%; }
        .nav-controls button { background-color: #2c3e50; flex: 1; max-width: 200px; }

        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 4px;
            opacity: 0; transition: 0.3s; z-index: 1000;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="embed">
    <header class="full-view">
        <h1>lipu sewi</h1>
        <p>Bible in Toki Pona</p>
    </header>
    
    <div class="controls full-view">
        <select id="testament-select">
            <option value="old_testament">Old Testament</option>
            <option value="new_testament">New Testament</option>
        </select>
        <select id="book-select"></select>
        <select id="chapter-select"></select>
        <button id="load-button">Load Chapter</button>
        
        <div class="display-options">
            <label><input type="checkbox" id="sitelen-pona-toggle"> Show sitelen pona</label>
            <label><input type="checkbox" id="isolated-toggle"> Selected only</label>
        </div>
    </div>
    
    <div class="nav-controls full-view">
    	<button id="prev-chapter">← Previous</button>
    	<button id="next-chapter">Next →</button>
	</div>
    
    <div id="missing-verses-container"></div>
    <div id="chapter-display" class="latina-pona-mode">
        <div class="loading">Select a book and chapter to begin</div>
    </div>

    <div class="share-section full-view" style="text-align: center; margin: 20px;">
        <button id="share-button" style="background-color: #2ecc71;">Copy Link to Share</button>
    </div>

    <div class="font-status full-view" style="text-align:center; color:#777;">
        Font status: <span id="statusText">checking…</span>
        <button id="reload" style="padding:2px 10px; font-size:12px; color:#333;">Reload Font</button>
    </div>

    <div id="toast" class="toast">Link copied!</div>

    <script>
        // --- DATA & CONSTANTS ---
        const BIBLE_BOOKS = {
            "old_testament": {
                "genesis": { chapters: 50, name: "Genesis", id: 1 }, "exodus": { chapters: 40, name: "Exodus", id: 2 },
                "leviticus": { chapters: 27, name: "Leviticus", id: 3 }, "numbers": { chapters: 36, name: "Numbers", id: 4 },
                "deuteronomy": { chapters: 34, name: "Deuteronomy", id: 5 }, "joshua": { chapters: 24, name: "Joshua", id: 6 },
                "judges": { chapters: 21, name: "Judges", id: 7 }, "ruth": { chapters: 4, name: "Ruth", id: 8 },
                "1_samuel": { chapters: 31, name: "1 Samuel", id: 9 }, "2_samuel": { chapters: 24, name: "2 Samuel", id: 10 },
                "1_kings": { chapters: 22, name: "1 Kings", id: 11 }, "2_kings": { chapters: 25, name: "2 Kings", id: 12 },
                "1_chronicles": { chapters: 29, name: "1 Chronicles", id: 13 }, "2_chronicles": { chapters: 36, name: "2 Chronicles", id: 14 },
                "ezra": { chapters: 10, name: "Ezra", id: 15 }, "nehemiah": { chapters: 13, name: "Nehemiah", id: 16 },
                "esther": { chapters: 10, name: "Esther", id: 17 }, "job": { chapters: 42, name: "Job", id: 18 },
                "psalms": { chapters: 150, name: "Psalms", id: 19 }, "proverbs": { chapters: 31, name: "Proverbs", id: 20 },
                "ecclesiastes": { chapters: 12, name: "Ecclesiastes", id: 21 }, "song_of_songs": { chapters: 8, name: "Song of Solomon", id: 22 },
                "isaiah": { chapters: 66, name: "Isaiah", id: 23 }, "jeremiah": { chapters: 52, name: "Jeremiah", id: 24 },
                "lamentations": { chapters: 5, name: "Lamentations", id: 25 }, "ezekiel": { chapters: 48, name: "Ezekiel", id: 26 },
                "daniel": { chapters: 12, name: "Daniel", id: 27 }, "hosea": { chapters: 14, name: "Hosea", id: 28 },
                "joel": { chapters: 3, name: "Joel", id: 29 }, "amos": { chapters: 9, name: "Amos", id: 30 },
                "obadiah": { chapters: 1, name: "Obadiah", id: 31 }, "jonah": { chapters: 4, name: "Jonah", id: 32 },
                "micah": { chapters: 7, name: "Micah", id: 33 }, "nahum": { chapters: 3, name: "Nahum", id: 34 },
                "habakkuk": { chapters: 3, name: "Habakkuk", id: 35 }, "zephaniah": { chapters: 3, name: "Zephaniah", id: 36 },
                "haggai": { chapters: 2, name: "Haggai", id: 37 }, "zechariah": { chapters: 14, name: "Zechariah", id: 38 },
                "malachi": { chapters: 4, name: "Malachi", id: 39 }
            },
            "new_testament": {
                "matthew": { chapters: 28, name: "Matthew", id: 40 }, "mark": { chapters: 16, name: "Mark", id: 41 },
                "luke": { chapters: 24, name: "Luke", id: 42 }, "john": { chapters: 21, name: "John", id: 43 },
                "acts": { chapters: 28, name: "Acts", id: 44 }, "romans": { chapters: 16, name: "Romans", id: 45 },
                "1_corinthians": { chapters: 16, name: "1 Corinthians", id: 46 }, "2_corinthians": { chapters: 13, name: "2 Corinthians", id: 47 },
                "galatians": { chapters: 6, name: "Galatians", id: 48 }, "ephesians": { chapters: 6, name: "Ephesians", id: 49 },
                "philippians": { chapters: 4, name: "Philippians", id: 50 }, "colossians": { chapters: 4, name: "Colossians", id: 51 },
                "1_thessalonians": { chapters: 5, name: "1 Thessalonians", id: 52 }, "2_thessalonians": { chapters: 3, name: "2 Thessalonians", id: 53 },
                "1_timothy": { chapters: 6, name: "1 Timothy", id: 54 }, "2_timothy": { chapters: 4, name: "2 Timothy", id: 55 },
                "titus": { chapters: 3, name: "Titus", id: 56 }, "philemon": { chapters: 1, name: "Philemon", id: 57 },
                "hebrews": { chapters: 13, name: "Hebrews", id: 58 }, "james": { chapters: 5, name: "James", id: 59 },
                "1_peter": { chapters: 5, name: "1 Peter", id: 60 }, "2_peter": { chapters: 3, name: "2 Peter", id: 61 },
                "1_john": { chapters: 5, name: "1 John", id: 62 }, "2_john": { chapters: 1, name: "2 John", id: 63 },
                "3_john": { chapters: 1, name: "3 John", id: 64 }, "jude": { chapters: 1, name: "Jude", id: 65 },
                "revelation": { chapters: 22, name: "Revelation", id: 66 }
            }
        };

        const NUM_LOOKUP = { 1:"wan", 2:"tu", 3:"tu-wan", 4:"tu-tu", 5:"luka", 10:"luka-luka", 20:"mute", 100:"ali" };
        const FALLBACK_SITELEN = { a:'awen', e:'e', i:'ijo', j:'jaki', k:'kalama', l:'laso', m:'mama', n:'nena', o:'olin', p:'pilin', s:'sike', t:'telo', u:'uta', w:'wawa' };
        
        // --- APP STATE ---
        let state = {
            testament: 'old_testament',
            book: 'genesis',
            chapter: 1,
            verse: null,
            sitelen: false,
            isolated: false,
            embed: false
        };

        const nameLookup = {};
        const sitelenNames = {};
        const verseCountCache = {};

        // --- UI ELEMENTS ---
        const ui = {
            testament: document.getElementById('testament-select'),
            book: document.getElementById('book-select'),
            chapter: document.getElementById('chapter-select'),
            display: document.getElementById('chapter-display'),
            missing: document.getElementById('missing-verses-container'),
            sitelenToggle: document.getElementById('sitelen-pona-toggle'),
            isolatedToggle: document.getElementById('isolated-toggle'),
            toast: document.getElementById('toast'),
            status: document.getElementById('statusText')
        };

        // --- HELPERS ---
        const showToast = (msg) => {
            ui.toast.textContent = msg;
            ui.toast.classList.add('show');
            setTimeout(() => ui.toast.classList.remove('show'), 2000);
        };

        const updateURL = () => {
            const params = new URLSearchParams();
            let cite = `${state.book.replace(/_/g, " ")} ${state.chapter}`;
            if (state.verse) cite += `:${state.verse}`;
            params.set('cite', cite);
            if (state.sitelen) params.set('sitelen', 'true');
            if (state.verse && state.isolated) params.set('iso', 'true');
            if (state.embed) params.set('embed', 'true');
            window.history.replaceState(null, '', `${window.location.origin}${window.location.pathname}?${params.toString()}`);
        };

        const numberToSitPona = (n) => {
            if (n === 0) return "";
            let keys = Object.keys(NUM_LOOKUP).map(Number).sort((a,b) => b-a);
            let result = [];
            for (let k of keys) {
                while (n >= k) {
                    result.push(NUM_LOOKUP[k]);
                    n -= k;
                }
            }
            return result.join(" ");
        };

        const numberToNasinNanpa = (n) => {
            if (n <= 100) return numberToSitPona(n);
            let str = n.toString();
            if (str.length % 2 !== 0) str = "0" + str;
            let pairs = str.match(/.{1,2}/g).map(Number);
            return pairs.map((v, i) => {
                let pref = v !== 0 ? numberToSitPona(v) + " " : "";
                return i < pairs.length - 1 ? pref + "ali" : pref;
            }).join(" ").trim();
        };

        // --- CORE LOGIC ---
        async function fetchChapter() {
            const formatted = state.chapter.toString().padStart(4, '0');
            const url = `https://raw.githubusercontent.com/PaulieGlot/lipu-sewi/master/bible/${state.testament}/${state.book}/${formatted}.txt`;
            
            ui.display.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const [resp, expectedCount] = await Promise.all([
                    fetch(url),
                    getVerseCount(BIBLE_BOOKS[state.testament][state.book].id, state.chapter)
                ]);
                
                if (!resp.ok) throw new Error("Chapter not found");
                const text = await resp.text();
                renderChapter(text, expectedCount);
                updateURL();
            } catch (e) {
                ui.display.innerHTML = `<div class="error">Error: ${e.message}</div>`;
            }
        }

        async function getVerseCount(bookId, chap) {
            const key = `${bookId}-${chap}`;
            if (verseCountCache[key]) return verseCountCache[key];
            try {
                const r = await fetch(`https://bolls.life/get-text/ASV/${bookId}/${chap}/`);
                const data = await r.json();
                verseCountCache[key] = data.length;
                return data.length;
            } catch { return 25; }
        }

        function renderChapter(text, expected) {
            const lines = text.split('\n').filter(l => l.trim());
            const bookName = BIBLE_BOOKS[state.testament][state.book].name;
            let html = `<div class="chapter-header"><h2 class="chapter-title">${bookName} ${state.chapter}</h2></div>`;
            
            let count = 0;
            lines.forEach(line => {
                const match = line.match(/^(\d+):\s*([?!])\s*(.*)$/);
                if (match) {
                    count++;
                    const [_, num, status, content] = match;
                    const isHigh = state.verse == num;
                    html += `
                        <div class="verse ${status === '!' ? 'solidified' : 'unsolidified'} ${isHigh ? 'highlighted' : ''}" id="verse-${num}">
                            <span class="verse-number-lt">${num}</span>
                            <span class="verse-content">${formatContent(content)}</span>
                            <span class="verse-number-st"><span class="sitelen">${numberToNasinNanpa(num)}</span></span>
                        </div>`;
                }
            });

            ui.display.innerHTML = html;
            ui.missing.innerHTML = count < expected ? `<div class="missing-verses">Translated: ${count}/${expected}</div>` : '';
            
            if (state.isolated) ui.display.classList.add('isolated');
            if (state.sitelen) ui.display.classList.add('sitelen-pona-mode');

            if (state.verse) {
                const el = document.getElementById(`verse-${state.verse}`);
                if (el) setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            }
        }

        function formatContent(text) {
            // Simplified name handling & number conversion
            let processed = text.replace(/&/g, "~").replace(/([.;!:?])/g, "$1 ");
            
            return processed.split(" ").map(word => {
                if (word.startsWith("~")) {
                    const name = word.slice(1).replace(/[,.;!?]/g, "");
                    return `<span class="name-tp">${name}</span><span class="name-rect">[${name}]</span>`;
                }
                if (/^\d+$/.test(word)) return numberToNasinNanpa(parseInt(word));
                return word;
            }).join(" ");
        }

        // --- INITIALIZATION ---
        function init() {
            // Populate Books
            const updateBooks = () => {
                ui.book.innerHTML = Object.entries(BIBLE_BOOKS[ui.testament.value])
                    .map(([id, info]) => `<option value="${id}">${info.name}</option>`).join("");
                updateChapters();
            };

            const updateChapters = () => {
                const count = BIBLE_BOOKS[ui.testament.value][ui.book.value].chapters;
                ui.chapter.innerHTML = Array.from({length: count}, (_, i) => `<option value="${i+1}">Chapter ${i+1}</option>`).join("");
            };

            ui.testament.onchange = updateBooks;
            ui.book.onchange = updateChapters;
            
            document.getElementById('load-button').onclick = () => {
                state.testament = ui.testament.value;
                state.book = ui.book.value;
                state.chapter = parseInt(ui.chapter.value);
                state.verse = null;
                fetchChapter();
            };

            ui.sitelenToggle.onchange = (e) => {
                state.sitelen = e.target.checked;
                ui.display.classList.toggle('sitelen-pona-mode', state.sitelen);
                updateURL();
            };

            ui.display.onclick = (e) => {
                const verseEl = e.target.closest('.verse');
                if (verseEl) {
                    const vNum = parseInt(verseEl.id.split('-')[1]);
                    document.querySelectorAll('.verse').forEach(v => v.classList.remove('highlighted'));
                    if (state.verse === vNum) {
                        state.verse = null;
                    } else {
                        state.verse = vNum;
                        verseEl.classList.add('highlighted');
                    }
                    updateURL();
                }
            };

            updateBooks();
            fetchChapter();
        }

        window.onload = init;
    </script>
</body>
</html>
